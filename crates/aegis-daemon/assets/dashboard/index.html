<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aegis Dashboard</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #0f141b;
        --panel: #151c26;
        --panel-2: #0b1119;
        --text: #e6edf3;
        --muted: #8b949e;
        --accent: #66c2ff;
        --ok: #3fb950;
        --warn: #f2cc60;
        --bad: #f85149;
        --border: #263445;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        background: var(--bg);
        color: var(--text);
      }
      header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 12px;
        padding: 12px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
      }
      .agent-item {
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 6px;
        cursor: pointer;
        background: var(--panel-2);
        border: 1px solid transparent;
      }
      .agent-item.active { border-color: var(--accent); }
      .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }
      .dot-ok { background: var(--ok); }
      .dot-warn { background: var(--warn); }
      .dot-bad { background: var(--bad); }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .frame {
        background: #0b0f16;
        border: 1px solid var(--border);
        border-radius: 6px;
        width: 100%;
        height: 360px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      canvas { width: 100%; height: 100%; }
      pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        color: var(--muted);
        font-size: 12px;
      }
      .row { display: flex; gap: 12px; align-items: center; }
      .muted { color: var(--muted); }
    </style>
  </head>
  <body>
    <header>
      <div>Aegis Dashboard</div>
      <div class="muted" id="status"></div>
    </header>
    <div class="layout">
      <div class="panel" id="agents"></div>
      <div class="panel">
        <div class="row">
          <div id="agent-title"></div>
          <div class="muted" id="agent-meta"></div>
        </div>
        <div class="grid" style="margin-top: 12px;">
          <div>
            <div class="muted">Latest Frame</div>
            <div class="frame"><canvas id="frame-canvas"></canvas></div>
          </div>
          <div>
            <div class="muted">Recent Tool Actions</div>
            <pre id="tool-actions"></pre>
            <div class="muted" style="margin-top: 12px;">Pending Approvals</div>
            <pre id="pending"></pre>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <div class="muted">Logs</div>
          <pre id="logs"></pre>
        </div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token") || "";
      let selected = null;
      let snapshot = null;

      function authHeaders() {
        return { "Authorization": "Bearer " + token };
      }

      async function fetchSnapshot() {
        const res = await fetch("/api/snapshot?token=" + encodeURIComponent(token));
        if (!res.ok) return null;
        return res.json();
      }

      function statusDot(status) {
        if (status.startsWith("running")) return "dot-ok";
        if (status.startsWith("pending")) return "dot-warn";
        return "dot-bad";
      }

      function renderAgents() {
        const container = document.getElementById("agents");
        container.innerHTML = "";
        if (!snapshot) return;
        snapshot.agents.forEach(a => {
          const div = document.createElement("div");
          div.className = "agent-item" + (selected === a.name ? " active" : "");
          div.innerHTML = `<div><span class="status-dot ${statusDot(a.status)}"></span>${a.name}</div>
            <div class="muted">${a.tool} • ${a.status}</div>`;
          div.onclick = () => { selected = a.name; renderDetail(); renderAgents(); };
          container.appendChild(div);
        });
        if (!selected && snapshot.agents.length) {
          selected = snapshot.agents[0].name;
          renderDetail();
          renderAgents();
        }
      }

      function decodeFrame(frame) {
        const canvas = document.getElementById("frame-canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = frame.width;
        canvas.height = frame.height;
        const raw = atob(frame.rgba_base64);
        const buf = new Uint8ClampedArray(raw.length);
        for (let i = 0; i < raw.length; i++) buf[i] = raw.charCodeAt(i);
        const img = new ImageData(buf, frame.width, frame.height);
        ctx.putImageData(img, 0, 0);
      }

      async function renderDetail() {
        if (!snapshot || !selected) return;
        const agent = snapshot.agents.find(a => a.name === selected);
        if (!agent) return;
        document.getElementById("agent-title").textContent = agent.name;
        document.getElementById("agent-meta").textContent =
          `${agent.tool} • ${agent.status}`;
        document.getElementById("tool-actions").textContent =
          agent.last_tool_action ? `${agent.last_tool_action}\n${agent.last_tool_note || ""}` : "(none)";
        document.getElementById("pending").textContent =
          agent.pending_prompts.length ? agent.pending_prompts.map(p => `${p.raw_prompt}`).join("\n") : "(none)";
        document.getElementById("logs").textContent = agent.last_output.join("\n");

        const res = await fetch(`/api/frame/${encodeURIComponent(agent.name)}?token=${encodeURIComponent(token)}`);
        if (res.ok) {
          const payload = await res.json();
          decodeFrame(payload.frame);
        }
      }

      function updateStatus() {
        if (!snapshot) return;
        document.getElementById("status").textContent = `Agents: ${snapshot.agents.length}`;
      }

      async function refresh() {
        snapshot = await fetchSnapshot();
        if (!snapshot) return;
        renderAgents();
        renderDetail();
        updateStatus();
      }

      function connectWS() {
        const ws = new WebSocket(`ws://${window.location.host}/ws?token=${encodeURIComponent(token)}`);
        ws.onmessage = (evt) => {
          snapshot = JSON.parse(evt.data);
          renderAgents();
          renderDetail();
          updateStatus();
        };
        ws.onclose = () => setTimeout(connectWS, 2000);
      }

      refresh();
      connectWS();
    </script>
  </body>
</html>
